name: üõ∏ WebView2 ‚Äî Release & Debug

on:
  workflow_dispatch:
    inputs:
      debug:
        type: boolean
        description: Enable Debug shell (tmate)
        default: false

jobs:
  webview2:
    name: WebView2-${{ matrix.config }}
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release, Debug]

    steps:
      - name: üì• Checkout (HTTPS + submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      # If any submodule uses git@‚Ä¶ URLs, rewrite to HTTPS to avoid SSH key prompts
      - name: üîÅ Force submodules to HTTPS
        shell: bash
        run: |
          if [ -f .gitmodules ]; then
            git config -f .gitmodules --get-regexp '^submodule\..*\.url$' | while read -r key url; do
              if [[ "$url" =~ ^git@github\.com: ]]; then
                https_url="https://github.com/${url#git@github.com:}"
                git config -f .gitmodules "$key" "$https_url"
              fi
            done
            git submodule sync --recursive
            git submodule update --init --recursive
          fi

      # Your repo's setup action (kept, in case it prepares toolchains/SDKs)
      - name: üëΩ Setup Saucer (WebView2 ${{ matrix.config }})
        uses: ./.github/actions/setup
        with:
          backend: WebView2
          platform: Windows
          build-type: ${{ matrix.config }}
          install: true
          xcode-version: ""
          cmake-args: -Dsaucer_tests=OFF -Dsaucer_examples=ON

      # üîß Explicit build (separate build dir per config to avoid generator clashes)
      - name: üõ†Ô∏è Configure (CMake) ‚Äî ${{ matrix.config }}
        run: >
          cmake -S . -B build-wv2-${{ matrix.config }}
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -Dsaucer_tests=OFF
          -Dsaucer_examples=ON
          -Dsaucer_backend=WebView2

      - name: üöÄ Build (CMake) ‚Äî ${{ matrix.config }}
        run: cmake --build build-wv2-${{ matrix.config }} --config ${{ matrix.config }} --parallel

      # (Optional) list outputs so we can tighten globs if needed
      - name: üìÇ List outputs ‚Äî ${{ matrix.config }}
        shell: pwsh
        run: |
          Get-ChildItem -Recurse -File -Include *.exe,*.dll,*.pdb -ErrorAction SilentlyContinue |
            Select-Object FullName, Length | Format-Table -AutoSize

      # Stage to a predictable folder, then upload
      - name: üß≥ Stage WebView2 outputs ‚Äî ${{ matrix.config }}
        shell: pwsh
        run: |
          $cfg = "${{ matrix.config }}"
          $build = "build-wv2-$cfg"
          $out = "out\WebView2\$cfg"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          $patterns = @(
            "$build\**\$cfg\**\*.exe",
            "$build\**\$cfg\**\*.dll",
            "$build\**\*.pdb",
            ".\artifact\**\*.*"   # in case your setup action writes here
          )

          $copied = 0
          foreach ($p in $patterns) {
            Get-ChildItem -Recurse -File -Path $p -ErrorAction SilentlyContinue | ForEach-Object {
              Copy-Item $_.FullName $out -Force
              $copied++
            }
          }

          # If your project doesn't auto-copy WebView2Loader.dll, try to add it from NuGet cache
          if (-not (Test-Path (Join-Path $out "WebView2Loader.dll"))) {
            $loader = Get-ChildItem -Recurse -File -Filter WebView2Loader.dll -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -match 'Microsoft\.Web\.WebView2' -and $_.FullName -match 'runtimes\\win-x64\\native\\WebView2Loader\.dll$' } |
              Select-Object -First 1
            if ($loader) { Copy-Item $loader.FullName $out -Force; $copied++ }
          }

          if ($copied -eq 0) {
            Write-Error "No build outputs found to stage for $cfg. Check the 'List outputs' step above to adjust paths."
          } else {
            Write-Host "Staged $copied files to $out"
            Get-ChildItem $out | Format-Table -AutoSize
          }

      - name: üì¶ Upload artifacts ‚Äî ${{ matrix.config }}
        uses: actions/upload-artifact@v4
        with:
          name: WebView2-${{ matrix.config }}
          path: out/WebView2/${{ matrix.config }}/**
          if-no-files-found: error
          retention-days: 14

      - name: üêõ Debug shell
        if: ${{ inputs.debug == true }}
        uses: mxschmitt/action-tmate@v3
        with:
          install-dependencies: false
          limit-access-to-actor: true
